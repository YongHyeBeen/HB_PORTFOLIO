#!/usr/bin/python3
# 파일명 : vul_check_U_07.python3
# 취약코드 : U-07(상)
# 점검항목 : /etc/passwd 파일 소유자 및 권한 설정
# 점검내용 : /etc/passwd 파일 권한 적절성 점검
# 양호기준 : /etc/passwd 파일의 소유자가 root이고, 권한이 644 이하인 경우
# 취약기준 : /etc/passwd 파일의 소유자가 root가 아니거나, 권한이 644 이하가 아닌 경우


import re
import os
good = "\033[94m양호\033[0m"
bad = "\033[91m취약\033[0m"

class PermBool:
    def __init__(self, perm):
        code_ref = {'---':0, '--x':1, '-w-':2, '-wx':3, 'r--':4, 'r-x':5, 'rw-':6, 'rwx':7}
        self.perm = perm
        self.code   = code_ref[self.perm]
        self.is_read    = True if perm[0] == 'r' else False
        self.is_write   = True if perm[1] == 'w' else False
        self.is_execute  = True if perm[2] in ('x', 's', 't') else False
        self.is_setuid  = True if perm[2] in ('S', 's') else False
        self.is_setgid  = True if perm[2] in ('S', 's') else False
        self.is_sticky  = True if perm[2] in ('T', 't') else False

class Perm:
    def __init__(self, perm):
        
        pat = re.compile(r"(?P<user>[rwxsS-]{3})(?P<group>[rwxsS-]{3})(?P<other>[rwstT-]{3})")
        match = pat.match(perm)
        self.perm    = perm
        self.user    = PermBool(match.group('user'))
        self.group   = PermBool(match.group('group'))
        self.other   = PermBool(match.group('other'))
   
class LS:
    def __init__(self, filename):
        os.environ['LANG'] = 'en_US.UTF-8'
        
        file = os.popen(f'ls -l {filename}')
        read = file.read().strip()
        file.close()
        
        pat = re.compile(r"[-dl](?P<perm>[rwxsS-]{3}[rwxsS-]{3}[rwstT-]{3})[.]?[ \t]+\d+[ \t]+(?P<username>[\w-]+)[ \t]+(?P<groupname>[\w-]+)[ \t]+(?P<size>\d+)")
        match = pat.search(read)
        self.username   = match.group("username")
        self.groupname  = match.group("groupname")
        self.size       = int(match.group("size"))
        self.perm       = Perm(match.group("perm"))


filename = '/etc/passwd'

obj = LS(filename)
if obj.username == 'root' and obj.perm.perm == 'rw-r--r--':
    print(f"{good} : {filename}의 소유주와 권한이 정상")
else:
    print(f"{bad} : {filename}의 소유주와 권한이 비정상")
    print(f"       - 소유주 : {obj.username}")
    print(f"       - 권   한 : {obj.perm.perm}")
